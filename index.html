<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trading Journal - บันทึกการเทรด</title>
    
    <!-- 1. Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. Fonts (Prompt) for Thai Language -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;700&display=swap" rel="stylesheet">

    <!-- 3. Styles -->
    <style>
        body { font-family: 'Prompt', sans-serif; }
        
        /* Custom Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in {
            animation: fadeIn 0.4s ease-out forwards;
        }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>

    <!-- 4. Import Maps for React & Libraries -->
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react/jsx-runtime": "https://esm.sh/react@18.2.0/jsx-runtime",
            "react-dom": "https://esm.sh/react-dom@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "lucide-react": "https://esm.sh/lucide-react@0.330.0?external=react",
            "recharts": "https://esm.sh/recharts@2.12.0?external=react,react-dom",
            "firebase/app": "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js",
            "firebase/auth": "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js",
            "firebase/firestore": "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js",
            "react-markdown": "https://esm.sh/react-markdown@9.0.1?external=react,react-dom"
        }
    }
    </script>
</head>
<body class="bg-slate-50 text-slate-900">
    <div id="root"></div>

    <!-- 5. Main Application Logic -->
    <script type="module">
        import React, { useState, useEffect, useMemo } from 'react';
        import { createRoot } from 'react-dom/client';
        import { initializeApp } from 'firebase/app';
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from 'firebase/auth';
        import { 
            getFirestore, collection, addDoc, query, orderBy, onSnapshot, 
            deleteDoc, doc, updateDoc, serverTimestamp, setDoc, getDoc 
        } from 'firebase/firestore';
        import { 
            LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, 
            ResponsiveContainer, ReferenceLine 
        } from 'recharts';
        import { 
            LayoutDashboard, PlusCircle, Save, Trash2, BookOpen, Target, 
            AlertCircle, Menu, X, Sparkles, BrainCircuit 
        } from 'lucide-react';
        import ReactMarkdown from 'react-markdown';

        // ==========================================
        // ⚙️ ตั้งค่า (CONFIG)
        // ==========================================
        
        const GEMINI_API_KEY = ""; 

        const manualFirebaseConfig = {
            apiKey: "AIzaSyDZS5BIcDzgvMcVYQj6uyrnCEn94xwulpA",
            authDomain: "maeplabybytserk.firebaseapp.com",
            projectId: "maeplabybytserk",
            storageBucket: "maeplabybytserk.firebasestorage.app",
            messagingSenderId: "816718961634",
            appId: "1:816718961634:web:0e5ffb83959d223f5f77bb",
            measurementId: "G-BVYWQJ4FJC"
        };
        
        // ==========================================
        // จบส่วนตั้งค่า (END CONFIG)
        // ==========================================

        // Initialize Firebase
        let app, auth, db, finalAppId;
        
        try {
            const isEnvAvailable = typeof __firebase_config !== 'undefined';
            const configToUse = isEnvAvailable ? JSON.parse(__firebase_config) : manualFirebaseConfig;
            
            app = initializeApp(configToUse);
            auth = getAuth(app);
            db = getFirestore(app);
            finalAppId = (typeof __app_id !== 'undefined') ? __app_id : "trading-journal-app";
            
        } catch (e) {
            console.error("Firebase Init Error:", e);
        }

        // --- Gemini API Call ---
        const callGemini = async (prompt) => {
            if (!GEMINI_API_KEY) return "⚠️ กรุณาใส่ Gemini API Key ในโค้ด (บรรทัดที่ 64) เพื่อใช้งานฟีเจอร์ AI";
            try {
                const response = await fetch(
                    `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${GEMINI_API_KEY}`,
                    {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] }),
                    }
                );
                if (!response.ok) throw new Error(`API Error: ${response.status}`);
                const data = await response.json();
                return data.candidates?.[0]?.content?.parts?.[0]?.text || "No response generated.";
            } catch (error) {
                console.error("Gemini API Error:", error);
                return "ขออภัย ระบบขัดข้องชั่วคราว หรือ API Key ไม่ถูกต้อง (Sorry, API Error)";
            }
        };

        // --- Components ---

        // 1. Dashboard
        const Dashboard = ({ trades }) => {
            const [aiAnalysis, setAiAnalysis] = useState(null);
            const [isAnalyzing, setIsAnalyzing] = useState(false);

            const stats = useMemo(() => {
                let totalTrades = trades.length;
                let wins = trades.filter(t => t.plAmount > 0).length;
                let losses = trades.filter(t => t.plAmount < 0).length;
                let totalPL = trades.reduce((acc, t) => acc + (Number(t.plAmount) || 0), 0);
                let winRate = totalTrades > 0 ? (wins / totalTrades) * 100 : 0;
                
                let runningTotal = 0;
                const chartData = [...trades]
                    .sort((a, b) => new Date(a.date) - new Date(b.date))
                    .map(t => {
                        runningTotal += Number(t.plAmount) || 0;
                        return { date: t.date, pl: runningTotal };
                    });

                return { totalTrades, wins, losses, totalPL, winRate, chartData };
            }, [trades]);

            const handleAnalyze = async () => {
                if (trades.length === 0) {
                    setAiAnalysis("ยังไม่มีข้อมูลการเทรดเพียงพอสำหรับการวิเคราะห์ (Not enough data)");
                    return;
                }
                setIsAnalyzing(true);
                const recentTrades = trades.slice(0, 15).map(t => 
                    `- ผลลัพธ์: ${t.status} (${t.plAmount}$), อารมณ์: ${t.emotion}, ข้อผิดพลาด: ${t.mistake || '-'}, Setup: ${t.setup}`
                ).join('\n');

                const prompt = `
                    You are a Trading Coach. Analyze these trades (Thai context):
                    ${recentTrades}
                    Provide analysis in Thai (Markdown):
                    1. รูปแบบที่พบ (Pattern)
                    2. จุดแข็ง (Strengths)
                    3. คำแนะนำ 3 ข้อ (Advice)
                `;
                const result = await callGemini(prompt);
                setAiAnalysis(result);
                setIsAnalyzing(false);
            };

            return React.createElement('div', { className: "space-y-6 animate-fade-in" },
                // AI Coach
                React.createElement('div', { className: "bg-gradient-to-r from-indigo-50 to-blue-50 p-6 rounded-xl shadow-sm border border-indigo-100" },
                    React.createElement('div', { className: "flex justify-between items-start mb-4" },
                        React.createElement('div', { className: "flex items-center gap-3" },
                            React.createElement('div', { className: "bg-white p-2 rounded-lg shadow-sm" },
                                React.createElement(BrainCircuit, { className: "w-6 h-6 text-indigo-600" })
                            ),
                            React.createElement('div', null,
                                React.createElement('h3', { className: "text-lg font-bold text-indigo-900" }, "AI Trading Coach (โค้ชส่วนตัว)"),
                                React.createElement('p', { className: "text-sm text-indigo-600" }, "วิเคราะห์พฤติกรรมการเทรดด้วย AI")
                            )
                        ),
                        React.createElement('button', {
                            onClick: handleAnalyze,
                            disabled: isAnalyzing,
                            className: "bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg text-sm font-medium flex items-center gap-2 shadow-md transition-all disabled:opacity-70"
                        }, isAnalyzing ? "กำลังวิเคราะห์... (Analyzing)" : [React.createElement(Sparkles, { className: "w-4 h-4", key: "icon" }), " เริ่มวิเคราะห์ (Analyze)"])
                    ),
                    aiAnalysis && React.createElement('div', { className: "bg-white/80 p-5 rounded-lg border border-indigo-100 text-slate-800 text-sm leading-relaxed shadow-inner" },
                        React.createElement(ReactMarkdown, { className: "prose prose-sm max-w-none text-slate-700" }, aiAnalysis)
                    )
                ),
                // Stats Grid
                React.createElement('div', { className: "grid grid-cols-1 md:grid-cols-4 gap-4" },
                    [
                        { label: "Net Profit (กำไรสุทธิ)", val: `$${stats.totalPL.toFixed(2)}`, color: stats.totalPL >= 0 ? 'text-emerald-600' : 'text-rose-600' },
                        { label: "Win Rate (อัตราชนะ)", val: `${stats.winRate.toFixed(1)}%`, sub: `${stats.wins} W - ${stats.losses} L` },
                        { label: "Total Trades (เทรดทั้งหมด)", val: stats.totalTrades },
                        { label: "Avg P/L (กำไรเฉลี่ย/ไม้)", val: `$${stats.totalTrades > 0 ? (stats.totalPL / stats.totalTrades).toFixed(2) : '0.00'}` }
                    ].map((item, idx) => 
                        React.createElement('div', { key: idx, className: "bg-white p-6 rounded-xl shadow-sm border border-slate-100" },
                            React.createElement('p', { className: "text-slate-500 text-sm font-medium" }, item.label),
                            React.createElement('p', { className: `text-2xl font-bold ${item.color || 'text-slate-800'}` }, item.val),
                            item.sub && React.createElement('p', { className: "text-xs text-slate-400" }, item.sub)
                        )
                    )
                ),
                // Chart
                React.createElement('div', { className: "bg-white p-6 rounded-xl shadow-sm border border-slate-100" },
                    React.createElement('h3', { className: "text-lg font-bold text-slate-800 mb-4" }, "Port Growth Curve (กราฟการเติบโตพอร์ต)"),
                    React.createElement('div', { className: "h-64 w-full" },
                        React.createElement(ResponsiveContainer, { width: "100%", height: "100%" },
                            React.createElement(LineChart, { data: stats.chartData },
                                React.createElement(CartesianGrid, { strokeDasharray: "3 3", vertical: false, stroke: "#e2e8f0" }),
                                React.createElement(XAxis, { dataKey: "date", tick: { fontSize: 12 }, stroke: "#94a3b8" }),
                                React.createElement(YAxis, { tick: { fontSize: 12 }, stroke: "#94a3b8" }),
                                React.createElement(Tooltip, { contentStyle: { borderRadius: '8px', border: 'none' } }),
                                React.createElement(ReferenceLine, { y: 0, stroke: "#94a3b8" }),
                                React.createElement(Line, { type: "monotone", dataKey: "pl", stroke: "#3b82f6", strokeWidth: 2, dot: { r: 3 } })
                            )
                        )
                    )
                )
            );
        };

        // 2. Journal Form
        const JournalForm = ({ user, onClose }) => {
            const [formData, setFormData] = useState({
                date: new Date().toISOString().split('T')[0], pair: '', direction: 'BUY',
                entryPrice: '', exitPrice: '', lotSize: '', plAmount: '', plPercent: '',
                setup: '', emotion: 'Neutral', mistake: '', lesson: '', confidence: 5, status: 'WIN'
            });
            const [loading, setLoading] = useState(false);

            const handleSubmit = async (e) => {
                e.preventDefault();
                if (!user) return;
                setLoading(true);
                try {
                    await addDoc(collection(db, 'artifacts', finalAppId, 'users', user.uid, 'trades'), {
                        ...formData,
                        entryPrice: Number(formData.entryPrice) || 0,
                        exitPrice: Number(formData.exitPrice) || 0,
                        lotSize: Number(formData.lotSize) || 0,
                        plAmount: Number(formData.plAmount) || 0,
                        confidence: Number(formData.confidence),
                        timestamp: serverTimestamp()
                    });
                    onClose();
                } catch (error) {
                    console.error("Error", error);
                    alert("บันทึกไม่สำเร็จ: " + error.message);
                } finally { setLoading(false); }
            };

            const handleChange = (e) => setFormData(p => ({ ...p, [e.target.name]: e.target.value }));

            return React.createElement('div', { className: "bg-white p-6 rounded-xl shadow-lg border border-slate-100 max-w-4xl mx-auto animate-fade-in" },
                React.createElement('div', { className: "flex justify-between items-center mb-6 border-b pb-4" },
                    React.createElement('h2', { className: "text-xl font-bold text-slate-800 flex items-center gap-2" }, 
                        React.createElement(PlusCircle, { className: "text-blue-600" }), "บันทึกเทรดใหม่ (New Trade)"
                    ),
                    React.createElement('button', { onClick: onClose, className: "text-slate-400 hover:text-slate-600" }, React.createElement(X))
                ),
                React.createElement('form', { onSubmit: handleSubmit, className: "space-y-6" },
                    React.createElement('div', { className: "grid grid-cols-1 md:grid-cols-3 gap-4" },
                        React.createElement('div', null,
                            React.createElement('label', { className: "block text-sm font-medium mb-1" }, "Date (วันที่)"),
                            React.createElement('input', { type: "date", name: "date", value: formData.date, onChange: handleChange, required: true, className: "w-full p-2 border rounded-lg" })
                        ),
                        React.createElement('div', null,
                            React.createElement('label', { className: "block text-sm font-medium mb-1" }, "Pair/Symbol (คู่เงิน)"),
                            React.createElement('input', { type: "text", name: "pair", value: formData.pair, onChange: handleChange, required: true, className: "w-full p-2 border rounded-lg uppercase" })
                        ),
                        React.createElement('div', null,
                            React.createElement('label', { className: "block text-sm font-medium mb-1" }, "Direction (ทิศทาง)"),
                            React.createElement('select', { name: "direction", value: formData.direction, onChange: handleChange, className: "w-full p-2 border rounded-lg" },
                                React.createElement('option', { value: "BUY" }, "BUY (Long - ขาขึ้น)"),
                                React.createElement('option', { value: "SELL" }, "SELL (Short - ขาลง)")
                            )
                        )
                    ),
                    React.createElement('div', { className: "grid grid-cols-2 md:grid-cols-4 gap-4 bg-slate-50 p-4 rounded-lg" },
                        React.createElement('div', null,
                            React.createElement('label', { className: "block text-xs font-medium text-slate-500 mb-1" }, "Entry Price (ราคาเข้า)"),
                            React.createElement('input', { type: "number", step: "any", name: "entryPrice", value: formData.entryPrice, onChange: handleChange, className: "w-full p-2 border rounded" })
                        ),
                        React.createElement('div', null,
                            React.createElement('label', { className: "block text-xs font-medium text-slate-500 mb-1" }, "Exit Price (ราคาออก)"),
                            React.createElement('input', { type: "number", step: "any", name: "exitPrice", value: formData.exitPrice, onChange: handleChange, className: "w-full p-2 border rounded" })
                        ),
                        React.createElement('div', null,
                            React.createElement('label', { className: "block text-xs font-medium text-slate-500 mb-1" }, "Lot Size (ขนาด Lot)"),
                            React.createElement('input', { type: "number", step: "any", name: "lotSize", value: formData.lotSize, onChange: handleChange, className: "w-full p-2 border rounded" })
                        ),
                        React.createElement('div', null,
                            React.createElement('label', { className: "block text-xs font-medium text-slate-500 mb-1" }, "Status (สถานะ)"),
                            React.createElement('select', { name: "status", value: formData.status, onChange: handleChange, className: "w-full p-2 border rounded font-bold" },
                                ['WIN (ชนะ)', 'LOSS (แพ้)', 'BE (เท่าทุน)', 'OPEN (ถือออเดอร์)'].map(op => React.createElement('option', { key: op, value: op.split(' ')[0] }, op))
                            )
                        )
                    ),
                    React.createElement('div', { className: "grid grid-cols-2 gap-4" },
                        React.createElement('div', null,
                            React.createElement('label', { className: "block text-sm font-medium mb-1" }, "P/L ($) (กำไร/ขาดทุน $)"),
                            React.createElement('input', { type: "number", step: "any", name: "plAmount", value: formData.plAmount, onChange: handleChange, required: true, className: "w-full p-2 border rounded-lg text-lg font-bold" })
                        ),
                        React.createElement('div', null,
                            React.createElement('label', { className: "block text-sm font-medium mb-1" }, "P/L (%) (คิดเป็น %)"),
                            React.createElement('input', { type: "number", step: "any", name: "plPercent", value: formData.plPercent, onChange: handleChange, className: "w-full p-2 border rounded-lg" })
                        )
                    ),
                    React.createElement('div', { className: "space-y-4 border-t pt-4" },
                        React.createElement('div', null,
                             React.createElement('label', { className: "block text-sm font-medium mb-1" }, "Trade Setup / Reason (เหตุผลการเข้าเทรด)"),
                             React.createElement('textarea', { name: "setup", placeholder: "เช่น Breakout H4, RSI Divergence, ข่าว...", value: formData.setup, onChange: handleChange, className: "w-full p-2 border rounded-lg" })
                        ),
                        React.createElement('div', { className: "grid grid-cols-1 md:grid-cols-2 gap-4" },
                             React.createElement('div', null,
                                React.createElement('label', { className: "block text-sm font-medium mb-1" }, "Emotion (อารมณ์)"),
                                React.createElement('select', { name: "emotion", value: formData.emotion, onChange: handleChange, className: "w-full p-2 border rounded-lg" },
                                    ['Neutral (เฉยๆ)', 'Excited (ตื่นเต้น)', 'Fear (กลัว)', 'Greed (โลภ)', 'Revenge (อยากเอาคืน)', 'Tired (เหนื่อยล้า)'].map(e => React.createElement('option', { key: e, value: e.split(' ')[0] }, e))
                                )
                             ),
                             React.createElement('div', null,
                                React.createElement('label', { className: "block text-sm font-medium mb-1" }, "Confidence (ความมั่นใจ 1-10)"),
                                React.createElement('div', { className: "flex items-center gap-4" },
                                    React.createElement('input', { type: "range", min: "1", max: "10", name: "confidence", value: formData.confidence, onChange: handleChange, className: "w-full h-2 bg-slate-200 rounded-lg cursor-pointer" }),
                                    React.createElement('span', { className: "font-bold text-blue-600" }, formData.confidence)
                                )
                             )
                        ),
                        React.createElement('div', null,
                            React.createElement('label', { className: "block text-sm font-medium mb-1" }, "Mistakes (ข้อผิดพลาด)"),
                            React.createElement('textarea', { name: "mistake", placeholder: "เช่น เข้าเร็วไป, เลื่อน SL หนี...", value: formData.mistake, onChange: handleChange, className: "w-full p-2 border rounded-lg" })
                        ),
                        React.createElement('div', null,
                            React.createElement('label', { className: "block text-sm font-medium mb-1" }, "Lessons Learned (บทเรียน)"),
                            React.createElement('textarea', { name: "lesson", placeholder: "สิ่งที่ได้เรียนรู้จากไม้นี้...", value: formData.lesson, onChange: handleChange, className: "w-full p-2 border rounded-lg" })
                        )
                    ),
                    React.createElement('button', { disabled: loading, type: "submit", className: "w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-xl shadow-lg transition-all" },
                        loading ? "Saving... (กำลังบันทึก)" : "Save Trade Record (บันทึกข้อมูล)"
                    )
                )
            );
        };

        // 3. Trade List
        const TradeList = ({ trades, user }) => {
            const handleDelete = async (id) => {
                if (!user || !confirm("ยืนยันการลบ?")) return;
                await deleteDoc(doc(db, 'artifacts', finalAppId, 'users', user.uid, 'trades', id));
            };

            return React.createElement('div', { className: "bg-white rounded-xl shadow-sm border border-slate-100 overflow-hidden animate-fade-in" },
                React.createElement('div', { className: "overflow-x-auto" },
                    React.createElement('table', { className: "w-full text-sm text-left text-slate-600" },
                        React.createElement('thead', { className: "text-xs text-slate-700 uppercase bg-slate-50 border-b" },
                            React.createElement('tr', null,
                                ['Date (วันที่)', 'Pair (คู่เงิน)', 'Setup (เซตอัพ)', 'Dir (ทิศ)', 'Lot', 'Price (ราคา)', 'P/L ($)', 'Status (สถานะ)', 'Action'].map(h => React.createElement('th', { key: h, className: "px-4 py-3" }, h))
                            )
                        ),
                        React.createElement('tbody', null,
                            trades.length === 0 ? React.createElement('tr', null, React.createElement('td', { colSpan: 9, className: "px-4 py-8 text-center text-slate-400" }, "ยังไม่มีข้อมูล เริ่มบันทึกกันเถอะ!")) :
                            trades.map(t => React.createElement('tr', { key: t.id, className: "border-b hover:bg-slate-50" },
                                React.createElement('td', { className: "px-4 py-3" }, t.date),
                                React.createElement('td', { className: "px-4 py-3 font-bold" }, t.pair),
                                React.createElement('td', { className: "px-4 py-3 truncate max-w-xs" }, t.setup),
                                React.createElement('td', { className: "px-4 py-3 text-center" }, 
                                    React.createElement('span', { className: `px-2 py-1 rounded text-xs font-bold ${t.direction === 'BUY' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}` }, t.direction)
                                ),
                                React.createElement('td', { className: "px-4 py-3 text-right" }, t.lotSize),
                                React.createElement('td', { className: "px-4 py-3 text-right text-xs" }, `In: ${t.entryPrice}`, React.createElement('br'), `Out: ${t.exitPrice}`),
                                React.createElement('td', { className: `px-4 py-3 text-right font-bold ${t.plAmount >= 0 ? 'text-emerald-600' : 'text-rose-600'}` }, t.plAmount),
                                React.createElement('td', { className: "px-4 py-3 text-center font-bold" }, t.status),
                                React.createElement('td', { className: "px-4 py-3 text-center" }, 
                                    React.createElement('button', { onClick: () => handleDelete(t.id), className: "text-slate-400 hover:text-red-500" }, React.createElement(Trash2, { className: "w-4 h-4" }))
                                )
                            ))
                        )
                    )
                )
            );
        };

        // 4. Goals
        const GoalsSystem = ({ user }) => {
            const [goals, setGoals] = useState({ tradingGoal: '', tradingSystem: '', tradingRules: '' });
            const [loading, setLoading] = useState(false);
            const [msg, setMsg] = useState('');
            const [isRefining, setIsRefining] = useState({ field: '', loading: false });

            useEffect(() => {
                if (!user) return;
                getDoc(doc(db, 'artifacts', finalAppId, 'users', user.uid, 'settings', 'goals')).then(snap => {
                    if (snap.exists()) setGoals(snap.data());
                });
            }, [user]);

            const handleSave = async () => {
                if (!user) return;
                setLoading(true);
                try {
                    await setDoc(doc(db, 'artifacts', finalAppId, 'users', user.uid, 'settings', 'goals'), goals);
                    setMsg('Saved!'); setTimeout(() => setMsg(''), 2000);
                } catch (e) { console.error(e); } finally { setLoading(false); }
            };

            const refineWithAI = async (field, label) => {
                if (!goals[field]) return;
                setIsRefining({ field, loading: true });
                const prompt = `Refine this trading ${label} (Thai): "${goals[field]}". Make it professional & actionable.`;
                const text = await callGemini(prompt);
                if (confirm(`AI Suggestion (คำแนะนำจาก AI):\n\n${text}\n\nReplace (แทนที่)?`)) setGoals(p => ({ ...p, [field]: text }));
                setIsRefining({ field: '', loading: false });
            };

            return React.createElement('div', { className: "grid grid-cols-1 lg:grid-cols-2 gap-6 animate-fade-in" },
                [{ k: 'tradingGoal', l: 'Goals (เป้าหมาย)', i: Target, c: 'blue' }, { k: 'tradingSystem', l: 'System (ระบบเทรด)', i: BookOpen, c: 'purple' }, { k: 'tradingRules', l: 'Golden Rules (กฎเหล็ก)', i: AlertCircle, c: 'orange', full: true }].map(item => 
                    React.createElement('div', { key: item.k, className: `bg-white p-6 rounded-xl shadow-sm border border-slate-100 space-y-4 ${item.full ? 'lg:col-span-2' : ''}` },
                        React.createElement('div', { className: "flex justify-between" },
                            React.createElement('div', { className: "flex items-center gap-2" },
                                React.createElement(item.i, { className: `text-${item.c}-600` }),
                                React.createElement('h3', { className: "text-lg font-bold" }, item.l)
                            ),
                            React.createElement('button', { 
                                onClick: () => refineWithAI(item.k, item.l), disabled: isRefining.loading,
                                className: `text-xs bg-${item.c}-50 text-${item.c}-600 px-2 py-1 rounded flex items-center gap-1`
                            }, isRefining.loading && isRefining.field === item.k ? "..." : [React.createElement(Sparkles, { className: "w-3 h-3", key: "i" }), " AI Refine (ให้ AI ช่วยเกลา)"])
                        ),
                        React.createElement('textarea', { 
                            className: "w-full h-40 p-4 border rounded-lg bg-slate-50",
                            placeholder: "Write here... (เขียนที่นี่)",
                            value: goals[item.k],
                            onChange: e => setGoals(p => ({ ...p, [item.k]: e.target.value }))
                        }),
                        item.full && React.createElement('div', { className: "flex justify-end items-center gap-4" },
                            msg && React.createElement('span', { className: "text-green-600" }, msg),
                            React.createElement('button', { onClick: handleSave, disabled: loading, className: "bg-slate-800 text-white px-6 py-2 rounded-lg hover:bg-slate-900" }, 
                                React.createElement('div', { className: "flex items-center gap-2" }, React.createElement(Save, { className: "w-4 h-4" }), "Save All (บันทึก)")
                            )
                        )
                    )
                )
            );
        };

        // Main App
        const App = () => {
            const [user, setUser] = useState(null);
            const [tab, setTab] = useState('dashboard');
            const [formOpen, setFormOpen] = useState(false);
            const [trades, setTrades] = useState([]);
            const [menuOpen, setMenuOpen] = useState(false);

            useEffect(() => {
                if (!app) {
                    alert("⚠️ ไม่พบการตั้งค่า Firebase! ถ้าคุณใช้บน Netlify อย่าลืมแก้ไขค่า Config ในไฟล์");
                    return;
                }
                
                const initAuth = async () => {
                    try {
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await signInWithCustomToken(auth, __initial_auth_token);
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch(e) {
                        console.error("Auth Error:", e);
                    }
                };
                initAuth();
                
                return onAuthStateChanged(auth, setUser);
            }, []);

            useEffect(() => {
                if (!user) return;
                const q = query(collection(db, 'artifacts', finalAppId, 'users', user.uid, 'trades'));
                return onSnapshot(q, (snap) => {
                    const data = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                    data.sort((a, b) => new Date(b.date) - new Date(a.date) || b.timestamp?.seconds - a.timestamp?.seconds);
                    setTrades(data);
                });
            }, [user]);

            if (!app) return React.createElement('div', { className: "h-screen flex items-center justify-center text-red-500 font-bold" }, "Error: Missing Firebase Config in Code");

            return React.createElement('div', { className: "min-h-screen pb-10" },
                // Navbar
                React.createElement('nav', { className: "bg-white border-b sticky top-0 z-30 shadow-sm" },
                    React.createElement('div', { className: "max-w-7xl mx-auto px-4 h-16 flex justify-between items-center" },
                        React.createElement('div', { className: "flex items-center gap-3" },
                            React.createElement('div', { className: "bg-blue-600 text-white p-2 rounded-lg" }, React.createElement(LayoutDashboard)),
                            React.createElement('span', { className: "text-xl font-bold bg-gradient-to-r from-blue-700 to-blue-500 bg-clip-text text-transparent" }, "Trading Journal")
                        ),
                        // Desktop
                        React.createElement('div', { className: "hidden md:flex items-center gap-4" },
                            [
                                { id: 'dashboard', label: 'Dashboard (ภาพรวม)' },
                                { id: 'history', label: 'History (ประวัติ)' },
                                { id: 'goals', label: 'Goals (เป้าหมาย)' }
                            ].map(t => 
                                React.createElement('button', { 
                                    key: t.id, onClick: () => setTab(t.id),
                                    className: `px-3 py-2 rounded-md font-medium transition-colors ${tab === t.id ? 'bg-blue-50 text-blue-700' : 'text-slate-600 hover:bg-slate-50'}`
                                }, t.label)
                            ),
                            React.createElement('button', { onClick: () => setFormOpen(true), className: "bg-blue-600 text-white px-4 py-2 rounded-lg flex items-center gap-2 shadow hover:bg-blue-700" },
                                React.createElement(PlusCircle, { className: "w-4 h-4" }), "New Trade (เพิ่มไม้ใหม่)"
                            )
                        ),
                        // Mobile
                        React.createElement('button', { className: "md:hidden p-2", onClick: () => setMenuOpen(!menuOpen) },
                            menuOpen ? React.createElement(X) : React.createElement(Menu)
                        )
                    ),
                    menuOpen && React.createElement('div', { className: "md:hidden bg-white border-t p-4 space-y-2 shadow-lg" },
                         [
                            { id: 'dashboard', label: 'Dashboard (ภาพรวม)' },
                            { id: 'history', label: 'History (ประวัติ)' },
                            { id: 'goals', label: 'Goals (เป้าหมาย)' }
                        ].map(t => 
                            React.createElement('button', { key: t.id, onClick: () => { setTab(t.id); setMenuOpen(false); }, className: "block w-full text-left px-4 py-3 rounded-lg hover:bg-slate-50" }, t.label)
                        ),
                        React.createElement('button', { onClick: () => { setFormOpen(true); setMenuOpen(false); }, className: "block w-full text-center bg-blue-600 text-white px-4 py-3 rounded-lg font-bold mt-2" }, "New Trade (เพิ่มไม้ใหม่)")
                    )
                ),
                // Content
                React.createElement('main', { className: "max-w-7xl mx-auto px-4 py-8" },
                    formOpen && React.createElement('div', { className: "fixed inset-0 bg-slate-900/50 z-50 flex items-center justify-center p-4 backdrop-blur-sm overflow-y-auto" },
                        React.createElement('div', { className: "w-full max-w-4xl my-auto" }, React.createElement(JournalForm, { user, onClose: () => setFormOpen(false) }))
                    ),
                    tab === 'dashboard' && React.createElement(Dashboard, { trades }),
                    tab === 'history' && React.createElement(TradeList, { trades, user }),
                    tab === 'goals' && React.createElement(GoalsSystem, { user })
                )
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(React.createElement(App));
    </script>
</body>
</html>
